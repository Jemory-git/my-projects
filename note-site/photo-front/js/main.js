require(["jquery","index","create-element","showfiles","objectEqual","pop-up-box","ajax"],function(e,t,n,o,r,i,a){t();var s,l,f,c,d,u,p,h,v,m,g=[],y=[],b=[],w=1,x=[],k=e(window).width(),C=e("#save-btn"),O=e("#note-detail"),E=e("#note-name-span"),j=e("#note-date-span"),I=e("#detail-container"),S=e("#first-category"),A=e("#star-btn"),N=e("#new-note"),L=e("#shutdown-btn"),T=!0,D=!0,F=!0,q=!1,J=e("#shutdown-new-note-btn"),M=e("#edit-btn"),B=o.showFiles,H=e("#show-folder-tree"),P=e("#select-path-btn"),R=e("#path-confirm-btn"),X=e("#abandon-new-note-btn"),U=e("#folder-tree-container"),Y=e("#folder-tree-first"),W=e("#show-path"),z=e("#path-input"),G=e("#note-name-iput"),K=e("#search-btn"),Q=e("#search-input"),V=e("#new-note-textarea");function Z(e){for(var t=[],n=e.length,o=0;o<n;o++)"folder"===e[o].type&&t.push(e[o]);return t}function $(e){var t=e.split(","),n="/",o=s;return e.indexOf("[")>-1?(t.forEach(function(e,t){e.length;var r=e.lastIndexOf("["),i=e.substring(0,r),a=e.substr(r).match(/\d+/)[0];o=o[i][a],n=0===t?n+i+"/"+o.foldername:n+"/"+o.foldername}),{pathStr:n,destination:o}):"/"===e?{pathStr:n=e,destination:o.未分组}:{pathStr:n+=e,destination:o[e]}}function _(){N[0].style.top="100%",window.setTimeout(function(){N.hide()},300),T=!0}function ee(){G[0].value="",V.empty(),z.empty()}function te(e,t,o,r,i){n.createUlList(e,t,"folder-tree-items","icon-folder-close-alt icon-margin","cover-div",i),oe(r,o)}function ne(t){for(var n=e(".folder-line"),o=n.length,r=t;r<o;r++)e(n[r]).remove()}function oe(t,n){n&&e(n).find("span").removeClass("icon-folder-open-alt").addClass("icon-folder-close-alt"),t&&e(t).prevAll("span").removeClass("icon-folder-close-alt").addClass("icon-folder-open-alt")}function re(t){var n=document.createElement("div"),o=parseInt(t)+1;return n.className="folder-line",H.append(n),{folderArr:e(".folder-line"),number:o}}function ie(){I[0].style.left="100%",A.removeClass("icon-heart").addClass("icon-heart-empty")}function ae(e,t){var n=!1;return e.forEach(function(e,o){e.fileId===t&&(n=e)}),n}function se(e){return e<10?"0"+e:e}function le(e){var t=b.length,n=e||d;0===n.length||r.objectEqual(n,b[t-1])||b.push(n)}function fe(t,n,o,r){e(n).on(t,function(e){e.preventDefault();var t=e.target;t.className.indexOf(o)>-1&&r(t)})}h=function(e){s=e;var t=Object.keys(e);n.createUlList(t,S,"category-item","icon-folder-close-alt icon-margin"),function(){var e;Object.entries(s).forEach(function(e,t){e[1].length>0&&e[1].forEach(function(e,t){"folder"===e.type?g.push(e):"file"===e.type&&y.push(e)})}),e=Array.from(g);do{var t=[];e.forEach(function(n,o){n.files.length>0&&n.files.forEach(function(e,n){"folder"===e.type?(t.push(e),g.push(e)):"file"===e.type&&y.push(e)}),e=t})}while(e.length>0);0===x.length&&y.forEach(function(e,t){"yes"===e.stared&&x.push(e)});D&&(d=B(x),le(),D=!1)}()},(m=new XMLHttpRequest).onreadystatechange=function(){4===m.readyState&&200===m.status&&(v=JSON.parse(m.responseText),h(v))},m.open("POST","photo-server/server.js?type=pull",!0),m.send(),e("#new-note-btn").on("click",function(){T?(N.show(),window.setTimeout(function(){N[0].style.top="0"},100),T=!1):i.alert("您需要先完成编辑，再新建笔记!",1e3),F&&(P.on("click",function(){!function(){U.css("transform","scaleX(1)");var e=Object.keys(s);Y.text()||te(e,Y,!1,!1,{number:1})}()}),F=!1)}),R.on("click",function(){if(U.css("transform","scaleX(0)"),void 0===p||"未分组"===p){p="未分组",z.text("/未分组");var e=$(p);u=e.destination}else z.text(W.text())}),fe("click","#show-folder-tree","cover-div",function(t){var n=t.dataset.number;if("1"===n){var o=t.previousSibling.textContent,r=s[o];if(p=o,l=Z(r),ne(n),l.length>0){var i=re(n);te(l,i.folderArr[n],i.folderArr[n-1],t,{number:i.number})}else oe(t,e("#folder-tree-first"))}else if(n>1){p=t.dataset.position;var a,l,f=t.dataset.id;if(g.forEach(function(e,t){e.folderId===f&&(a=e.files,l=Z(a))}),ne(n),l.length>0){i=re(n);te(l,i.folderArr[n],i.folderArr[n-1],t,{number:i.number})}else oe(t,e(".folder-line")[n-1])}var c=$(p),d=c.pathStr;u=c.destination,W.text(d)}),e("#save-new-note-btn").on("click",function(){if(V.focus(),!z.text())return i.alert("请选择保存路径!",1e3),void V.blur();var e={},t=new Date,n=t.getMonth()+1,o=t.getDate(),r=t.getHours(),s=t.getMinutes(),l=G[0].value;if(!l)return i.alert("请填写笔记名字!",1e3),void V.blur();if(l.search(/[\,\[\]\'\"\<\>]{*}/)>-1)return i.alert("请填写合格的名字!",1e3),void V.blur();e.filename=l;var c=V.html();if(!V.text())return i.alert("请填写笔记内容!",1e3),void V.blur();if(e.detail=c,e.ctime=se(r)+":"+se(s),e.cdate=t.getFullYear()+"/"+se(n)+"/"+se(o),e.fileId="f"+t.getTime(),e.type="file",Array.isArray(u))e.fileFather=p,e.position=[p+"["+u.length+"]"],u.push(e),y.push(e),f=u;else{e.fileFather=u.folderId;var h=Array.from(u.position),v="files["+u.files.length+"]";h.push(v),e.position=h,u.files.push(e),y.push(e),f=u.files}var m={newFileObj:e,saveAddress:p};a.post("photo-server/server.js?type=newnote",JSON.stringify(m),function(){_(),ee(),V.blur(),i.alert("笔记保存成功!",1e3),d=B(f),le()},{contentType:"application/json"})}),X.on("click",function(){var e=G[0].value,t=z.text(),n=V.text();t||e||n?i.confirm("确认清空此次编辑内容？",function(){ee(),_()}):_()}),e("#remove-btn").on("click",function(){i.confirm("确定删除笔记吗？",function(){var e=O[0].dataset.position,t=O[0].dataset.id,n="photo-server/server.js?type=delete&position="+e;a.get(n,function(){i.alert("笔记删除成功!",1e3)}),d.forEach(function(e,n){e.fileId===t&&(e.showBoo="false")}),d=B(d),O.attr("contenteditable","false").css("background-color","#6b58ff"),ie(),T=!0})}),M.on("click",function(){O.attr("contenteditable","true").css("background-color","#fff").focus(),T=!1,q=!0}),O.on("focus",function(){O.html(c),k<769&&O.css("margin","50% auto 10%")}),O.on("blur",function(){c=O.html(),k<769&&O.css("margin","auto")}),C.on("click",function(){if(q)if(O.text()){O.focus();var e=O.html(),t=O[0].dataset.position.split(","),n=new Date,o=se(n.getHours())+":"+se(n.getMinutes()),r=n.getFullYear()+"/"+se(n.getMonth()+1)+"/"+se(n.getDate()),l=s,f={position:t,detail:e,mtime:o,mdate:r},c=JSON.stringify(f);j.text(f.mdate+" "+f.mtime),O.attr("contenteditable","false").css("background-color","#6b58ff"),t.forEach(function(e,t){e.length;var n=e.lastIndexOf("["),o=e.substring(0,n),r=e.substr(n).match(/\d+/)[0];l=l[o][r]}),l.detail=e,a.post("photo-server/server.js?type=save",c,function(){O.blur(),i.alert("笔记保存成功!",1e3)},{contentType:"application/json"}),T=!0,q=!1}else i.alert("需要填写笔记内容!",1e3);else i.alert("笔记未更改!",1e3)}),L.on("click",function(){T?ie():i.alert("您需要先保存编辑，再关闭笔记!",1e3)}),J.on("click",function(){_()}),K.on("click",function(){var e=Q[0].value;if(parseInt(Q.css("width"))>100&&e){Q[0].style.width="0px",Q[0].style.paddingLeft="0px",Q.blur();var t=[];if(g.forEach(function(n,o){n.foldername.indexOf(e)>-1&&t.push(n)}),y.forEach(function(n,o){var r=n.filename.indexOf(e),i=n.detail.indexOf(e);(r>-1||i>-1)&&t.push(n)}),0===t.length)return void i.alert("没有该文件！",1e3);d=B(t),le()}}),e(document).on("keypress",function(e){if(13==(e.which||e.keycod)){var t=Q[0].value;if(parseInt(Q.css("width"))>100&&t){e.preventDefault(),Q[0].style.width="0px",Q[0].style.paddingLeft="0px",Q.blur();var n=[];if(g.forEach(function(e,o){e.foldername.indexOf(t)>-1&&n.push(e)}),y.forEach(function(e,o){var r=e.filename.indexOf(t),i=e.detail.indexOf(t);(r>-1||i>-1)&&n.push(e)}),0===n.length)return void i.alert("没有该文件！",1e3);d=B(n),le()}}}),A.on("click",function(){var e,t,n=O[0].dataset.id,o={contentType:"application/json"},r={position:O[0].dataset.position.split(",")};A.hasClass("icon-heart")?(e=ae(x,n),r.stared="no",t=JSON.stringify(r),e&&(x.pop(e),e.stared="no"),A.removeClass("icon-heart").addClass("icon-heart-empty"),a.post("photo-server/server.js?type=save",t,function(){i.alert("取消星标成功!",1e3)},o)):(e=ae(y,n),r.stared="yes",t=JSON.stringify(r),e&&(x.push(e),e.stared="yes"),A.removeClass("icon-heart-empty").addClass("icon-heart"),a.post("photo-server/server.js?type=save",t,function(){i.alert("星标成功!",1e3)},o))}),fe("click","#second-category","second-category",function(e){var t=e.parentNode.dataset.id,n=t.indexOf("o");n<0?y.forEach(function(e,n){e.fileId===t&&function(e){var t=e.detail,n=e.fileId,o=e.position.join(),r=e.filename,i=e.mdate?e.mdate+" "+e.mtime:e.cdate+" "+e.ctime;"p"==t[1]?O.html(t):O.html("<p>"+t+"</p>");O.attr("data-id",n),O.attr("data-position",o),c=O.html(),E.text(r),j.text(i),ae(x,n)&&A.removeClass("icon-heart-empty").addClass("icon-heart");k>768?I[0].style.left="20%":k<768&&(I[0].style.left="0")}(e)}):n>0&&g.forEach(function(e,n){if(e.folderId===t){var o=e.files;d=B(o),le()}})}),fe("click","#root-dir","category-item",function(t){if("SPAN"===t.tagName&&(t=e(t).next()[0]),l=s[t.textContent],d=B(l),le(),S.find("span").removeClass("icon-folder-open-alt").addClass("icon-folder-close-alt"),e(t).prev("span").removeClass("icon-folder-close-alt").addClass("icon-folder-open-alt"),k<=768){var n=S[0].getBoundingClientRect(),o=t.getBoundingClientRect(),r=o.left,i=o.width,a=t.offsetParent.offsetWidth,f=S[0].scrollLeft,c=a-n.width,u=[.5*i+n.left,n.left+3.5*i];if(r>=u[1]){h=(h=f+i)>c?c:h;var p=window.setInterval(function(){S.scrollLeft(f+=10),f>=h&&window.clearInterval(p)},20)}else if(r<=u[0]){var h;h=(h=f-i)<0?0:h;p=window.setInterval(function(){S.scrollLeft(f-=10),f<=h&&window.clearInterval(p)},20)}}}),fe("click","#functions","back-btn",function(e){var t=b.length;0!==t&&1!==t&&(d=B(b[t-(w=w<t?w+1:1)]))}),fe("click","#functions","forward-btn",function(e){var t=b.length;0!==t&&1!==t&&(w>1?w-=1:1===w&&t>1&&(w=t),d=B(b[t-w]))})});